services:
  bolt-nbility-core:
    # FIX NBILITY v4.5: Use local build instead of official image to fix wrangler PATH issue
    build:
      context: ./bolt.diy
      dockerfile: Dockerfile
      target: bolt-ai-production
    container_name: bolt-nbility-core
    restart: always
    environment:
      - NODE_ENV=production
    volumes:
      - bolt-nbility-data:/app/data
    expose:
      - "5173"
    networks:
      - bolt-network-app

  bolt-nbility-nginx:
    image: nginx:stable-alpine
    container_name: bolt-nbility-nginx
    restart: always
    depends_on:
      - bolt-nbility-core
    volumes:
      - ./DATA-LOCAL/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./DATA-LOCAL/nginx/html:/usr/share/nginx/html:ro
      - ${HTPASSWD_FILE}:/etc/nginx/.htpasswd:ro
    ports:
      - "${HOST_PORT_HTTP}:80"
      - "${HTTPS_HOST_PORT}:443"
    networks:
      - bolt-network-app

  bolt-user-manager:
    image: bolt-user-manager:latest
    container_name: bolt-user-manager
    restart: always
    user: "root"
    volumes:
      - ./DATA-LOCAL/user-manager/app:/var/www/html
      - ${HTPASSWD_FILE}:/app/.htpasswd:rw
    environment:
      HTPASSWD_FILE: /app/.htpasswd
    ports:
      - "${HOST_PORT_UM}:80"
    networks:
      - bolt-network-app

networks:
  bolt-network-app:
    external: true
    
volumes:
  bolt-nbility-data:
    external: true
  bolt-nbility-nginx-conf:
    external: true
